# 模型文件作用
## 对话模板
chat_template.json定义聊天模型的对话模板，包含对话角色标记（如System、User、Assistant等）、对话结构、特殊标记等，确保模型能够理解上下文并生成合适的回复

## 模型配置文件
config.json为模型的配置文件，定义模型架构和超参数，包含隐藏层大小、注意力头数量、层数、激活函数类型等参数，用于加载模型架构并确保一致性。

## 
configuration.json

## 生成配置
generation_config.json定义模型生成文本时的默认配置，包含最大生成长度、temperature、top-k、top-p、重复惩罚等参数，提供生成文本时的默认设置

## 分词器合并规则文件
merge.txt为BPE分词器的合并规则文件，包含字符或子词的合并规则，按频率排序，与词汇表一起完成分词过程。

## 模型权重分片的索引文件
model.safetensors.index.json为模型权重分片的索引文件，描述每个参数张量所在的分片文件及偏移，帮助程序高效加载权重。

## 模型权重文件
model-***.safetensors模型权重文件，以`safetensors`格式保存，权重被分割为多个分片文件，安全高效存储模型权重。

## 预处理器配置文件
preprocessor_config.json为预处理器配置文件，定义输入数据预处理步骤，包含图像尺寸、归一化参数、数据增强策略等，确保输入数据与训练数据一致。

## 分词器完整配置文件
tokenizer.json分词器完整配置文件，包含词汇表、BPE合并规则、分词器类型等，用于重建分词器并确保分词过程与训练一致。

## 分词器的参数和特定设置
tokenizer_config.json包含是否区分大小写、特殊标记ID、截断和填充策略等，确保分词器在不同环境中行为一致。

## 分词器词汇表
vocab.json分词器的词汇表文件，定义token到索引的映射关系，用于将文本转换为模型可识别的索引。

# 模型文件使用流程
- 加载模型配置：读取config.json构建模型架构
- 加载模型权重：使用 model.safetensors.index.json 定位并加载 model-*.safetensors 中的权重
- 加载分词器：通过 tokenizer.json 和 tokenizer_config.json 构建分词器
- 预处理输入：根据preprocessor_config.json对输入数据进行处理
- 生成文本：根据generation_config.json配置生成文本
- 处理对话：如果时聊天模型，使用chat_template.json定义对话格式和流程

# 对话模型格式
chat_template.json 文件包含了一个用于生成聊天对话的模板，模板使用了 Jinja2 模板语言构建，主要用于将输入的消息列表转换为特定格式的文本，使得模型可以理解并处理多模态（文本、图像、视频）的对话。

```Jinja2 {.line-numbers}
{% set image_count = namespace(value=0) %}
{% set video_count = namespace(value=0) %}
{# 初始化图片和视频的计数器 #}

{% for message in messages %}
    {# 遍历每一条消息 #}

    {% if loop.first and message['role'] != 'system' %}
        system
        You are a helpful assistant.
        {# 如果是第一条消息且角色不是 'system'，则输出系统提示 #}
    {% endif %}

    {{ message['role'] }}
    {# 输出消息的角色 #}

    {% if message['content'] is string %}
        {{ message['content'] }}
        {# 如果消息内容是字符串，直接输出 #}
    {% else %}
        {% for content in message['content'] %}
            {# 遍历消息内容中的每个元素 #}

            {% if content['type'] == 'image' or 'image' in content or 'image_url' in content %}
                {% set image_count.value = image_count.value + 1 %}
                {# 如果内容是图片，图片计数加一 #}

                {% if add_vision_id %}
                    Picture {{ image_count.value }}:
                    {# 如果需要添加视觉ID，输出图片编号 #}
                {% endif %}

                <|vision_start|><|image_pad|><|vision_end|>
                {# 输出图片的视觉标记占位符 #}

            {% elif content['type'] == 'video' or 'video' in content %}
                {% set video_count.value = video_count.value + 1 %}
                {# 如果内容是视频，视频计数加一 #}

                {% if add_vision_id %}
                    Video {{ video_count.value }}:
                    {# 如果需要添加视觉ID，输出视频编号 #}
                {% endif %}

                <|vision_start|><|video_pad|><|vision_end|>
                {# 输出视频的视觉标记占位符 #}

            {% elif 'text' in content %}
                {{ content['text'] }}
                {# 如果内容包含文本，输出文本内容 #}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}

{% if add_generation_prompt %}
    assistant
    {# 如果需要添加生成提示，输出 'assistant' #}
{% endif %}
```

## 初始化计数器
```Jinja2 {.line-numbers}
{% set image_count = namespace(value=0) %}
{% set video_count = namespace(value=0) %}
```

- 作用：创建可变的命名空间变量`image_count`和`video_count`，用于计数图片和视频的数量
- 解释：
    - 在 Jinja2 中，普通变量是不可变的。namespace 提供了可变的变量。
    - image_count.value 和 video_count.value 将用于跟踪出现的图片和视频数量。

## 遍历纤细
```Jinja2 {.line-numbers}
{% for message in messages %}
```
- 作用：开始遍历输入的消息列表 messages。
- 解释：
    - messages 应该是一个列表，每个元素是一个包含 role 和 content 的字典，代表一条消息。
    - role：消息的发送者，可以是 user（用户）、assistant（助手）、system（系统）等。
    - content：消息的内容，可能是字符串或包含多种内容的列表。

## 添加默认系统提示词（如需要）
```Jinja2 {.line-numbers}
{% if loop.first and message['role'] != 'system' %}
    system
    You are a helpful assistant.
    {# 如果是第一条消息且角色不是 'system'，则输出系统提示 #}
{% endif %}
```
- 作用：在对话开始时，如果第一条消息不是系统消息，插入默认的系统提示。
- 解释：
    - loop.first：检查是否是第一次迭代。
    - 如果对话的第一条消息不是来自 system，就添加默认的系统消息，告知模型 “You are a helpful assistant.”。
    - 使用特殊标记 和 包裹消息，表示一段消息的开始和结束。

## 开始新的消息块
```Jinja2 {.line-numbers}
{{ message['role'] }}
\n
```

# 模型配置文件格式

# 

https://blog.csdn.net/fydw_715/article/details/145762650